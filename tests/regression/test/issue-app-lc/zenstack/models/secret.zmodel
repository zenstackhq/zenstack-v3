import '../shared/timestamps'
import './account'
import './attendance'
import './enumerator-option'
import './instance'
import './user'

model Secret {
  id         String           @id @default(cuid())

  /// Name of the secret
  name       String

  /// Value of the secret (Ecnrypted value of the secret)
  value      String

  /// IV of the secret
  iv         String           @default('')

  /// Auth tag of the secret
  authTag    String           @default('')

  // Relations
  /// Account ID this secret belongs to
  accountId  String?

  /// The account this secret belongs to
  account    Account?         @relation(fields: [accountId], references: [id], onDelete: Cascade)

  /// Type ID of the secret
  typeId     String

  /// Type of the secret
  type       EnumeratorOption @relation(fields: [typeId], references: [id], onDelete: Cascade)

  /// The instance ID this secret belongs to
  instanceId String?

  /// The instance this secret belongs to
  instance   Instance?        @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  /// Users that have access to this secret
  users      User[]

  // TEMPORARY
  /// Date and time when the record was created, the default value is the current date and time
  createdAt       DateTime  @default(now())

  /// Identifier of the account who created the record
  createdById     String?

  /// Identifier of the user who created the record
  createdByUserId String?

  /// Date and time of the last update of the record, the default value is the current date and time
  updatedAt       DateTime? @updatedAt

  /// Identifier of the account who last updated the record
  updatedById     String?

  /// Identifier of the user who last updated the record
  updatedByUserId String?

  /// Indicates whether the record is marked as deleted
  deleted         Boolean   @default(false)

  /// Date and time of deletion of the record
  deletedAt       DateTime?

  /// Identifier of the account who deleted the record
  deletedById     String?

  /// Identifier of the user who deleted the record
  deletedByUserId String?

  @@allow(
    'read',
    accountId == auth().id // The secret belongs to the current account
    || createdById == auth().id // The secret was created by the current account
    || (instance.users?[accountId == auth().id] && users?[id == auth().id]) // The secret is shared with the current user

  // If the secret is not bound to an account, privileged users within the instance can read it
    || (accountId == null && instance.users?[accountId == auth().id && roles?[claims?[id == "secret:manage" || id == "all:read"]]])
  )

  @@allow(
    'create,update,delete',
    accountId == auth().id // The secret belongs to the current account
    || createdById == auth().id // The secret was created by the current account

  // If the secret is created on an instance level, the user must have the (secret:manage || all:manage) permission
    || (accountId == null && instance.users?[accountId == auth().id && roles?[claims?[id == "secret:manage" || id == "all:manage"]]])
  )

  @@index([value])
}
